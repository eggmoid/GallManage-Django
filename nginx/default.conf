server {
  listen 80;

  server_name           gall.kro.kr;

  rewrite ^(.*) https://gall.kro.kr$1 permanent;
}

server {
  listen 443 ssl;

  ssl                 on;
  ssl_certificate     /etc/ssl/certificate.crt;
  ssl_certificate_key /etc/ssl/private.key;

  server_name       gall.kro.kr;
  proxy_set_header  Host              $http_host;
  proxy_set_header  X-Real-IP         $remote_addr;
  proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header  X-Forwarded-Proto $scheme;

  location / {
    return 301 $scheme://$server_name/admin;
  }

  location /admin {
    proxy_pass http://127.0.0.1:8000/admin;
  }

  location /api {
    proxy_pass http://127.0.0.1:8000/api;
  }

  location /swagger {
    proxy_pass http://127.0.0.1:8000/swagger;
    proxy_http_version 1.1;
  }

  location /favicon.ico {
    alias /etc/nginx/django/static/favicon.ico;
  }

  location /static/ {
    alias /etc/nginx/django/static/;
  }

  location /static/js/ {
    proxy_pass http://127.0.0.1:5555/static/js/;
  }

  location /static/css/ {
    proxy_pass http://127.0.0.1:5555/static/css/;
  }

  location /static/img/ {
    proxy_pass http://127.0.0.1:5555/static/img/;
  }

  location /task {
    proxy_pass http://127.0.0.1:5555/task;
  }

  location /tasks {
    proxy_pass http://127.0.0.1:5555/tasks;
  }

  location /broker {
    proxy_pass http://127.0.0.1:5555/broker;
  }

  location /worker {
    proxy_pass http://127.0.0.1:5555/worker;
  }

  location /dashboard {
    return 301 $scheme://$server_name/flower;
  }

  location ~ ^/flower/? {
    rewrite ^/flower/?(.*)$ /$1 break;
    proxy_pass http://127.0.0.1:5555;
  }
}
